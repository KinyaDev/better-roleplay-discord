<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Better Roleplay Dashboard</title>
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body>
    <div id="container">
      <div id="header">
        <h1>Better Roleplay</h1>
      </div>
      <div id="content">
        <div class="description">
          <p>
            Elevate your roleplaying experience with Better Roleplay! Customize
            characters, manage them effortlessly, explore immersive locations,
            and define unique species. Enhance your storytelling with
            customizable stats and grant access to exclusive content using our
            key management system. Join now and unleash your creativity!
          </p>
        </div>

        <a
          id="login"
          style="display: none"
          href="https://discord.com/api/oauth2/authorize?client_id=1110594506220388352&redirect_uri=https%3A%2F%2Fbetter-roleplay.swameta.fr&response_type=token&scope=guilds%20identify"
          >Identify Yourself</a
        >

        <div id="guilds" style="display: none">
          <h2>Select a Guild</h2>
          <div id="guildList"></div>
        </div>

        <ul class="goals">
          <p>GOALS</p>
          <li>Reach 500 active servers to make a brand new dashboard</li>
          <li>
            We need your help to integrate ChatGPT (making automated NPCs). Fund
            me, join the Discord server!
          </li>
        </ul>

        <div class="work-in-progress">
          <h1>Work in Progress</h1>
          <br />
          <img
            src="https://i.pinimg.com/originals/19/bc/35/19bc35ab4e70986ce6a36f6d0d44e179.gif"
            alt="Work in Progress"
          />
        </div>

        <div id="footer">
          <ul>
            <li><a href="/privacy">Privacy Policy</a></li>
            <li><a href="/terms">Terms of Service</a></li>
          </ul>
        </div>
      </div>
    </div>
    <script>
      window.onload = () => {
        const fragment = new URLSearchParams(window.location.hash.slice(1));
        const [accessToken, tokenType, selectedGuildId] = [
          fragment.get("access_token"),
          fragment.get("token_type"),
          fragment.get("guild_id"),
        ];

        const container = document.getElementById("container");
        const loginButton = document.getElementById("login");
        const guildsContainer = document.getElementById("guilds");
        const guildList = document.getElementById("guildList");

        async function getGuild(guildid) {
          let response = await fetch(`/api/bot/guilds/${guildid}`);
          return await response.json();
        }

        async function setGuild(g) {
          guildsContainer.style.display = "none";
          let guild = await getGuild(g.id);
          if (Object.keys(guild).length === 0 && guild.constructor === Object)
            inviteBot(g.id);
          else {
            console.log(guild);
          }
        }

        if (!accessToken) {
          loginButton.style.display = "block";
        } else {
          fetch("https://discord.com/api/users/@me", {
            headers: {
              authorization: `${tokenType} ${accessToken}`,
            },
          })
            .then((result) => {
              if (result.status === 401) window.location.assign("/");
              else return result.json();
            })
            .then(async (response) => {
              const { username } = response;
              document.querySelector(
                "#header > h1"
              ).innerText = `Welcome, ${username}!`;

              if (!selectedGuildId) {
                fetch("https://discord.com/api/users/@me/guilds", {
                  headers: {
                    authorization: `${tokenType} ${accessToken}`,
                  },
                })
                  .then((result) => result.json())
                  .then((guilds) => {
                    guilds = guilds.filter((g) => g.owner);
                    if (guilds.length > 0) {
                      guildsContainer.style.display = "block";

                      guilds.forEach((guild) => {
                        const guildCard = document.createElement("div");
                        guildCard.classList.add("guild-card");
                        guildCard.addEventListener("click", async () => {
                          await setGuild(guild);
                        });

                        const guildIcon = document.createElement("img");
                        guildIcon.src = `https://cdn.discordapp.com/icons/${guild.id}/${guild.icon}.png`;
                        guildCard.appendChild(guildIcon);

                        const guildName = document.createElement("h3");
                        guildName.innerText = guild.name;
                        guildCard.appendChild(guildName);

                        guildList.appendChild(guildCard);
                      });
                    }
                  })
                  .catch(console.error);
              } else {
                let guild = await getGuild(selectedGuildId);
                console.log(guild);
              }
            })
            .catch(console.error);
        }

        function inviteBot(guildId) {
          window.location = `https://discord.com/api/oauth2/authorize?client_id=1110594506220388352&permissions=536881168&redirect_uri=https%3A%2F%2Fbetter-roleplay.swameta.fr&response_type=token&scope=guilds.join%20bot&guild_id=${guildId}`;
        }
      };
    </script>
  </body>
</html>
